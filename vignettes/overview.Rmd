---
output:
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
# output: rmarkdown::html_vignette
# output:
#   rmdformats::readthedown:
#     highlight: kate
author: Fabian Mueller
date: "`r Sys.Date()`"
title: ChrAccR
vignette: >
  %\VignetteIndexEntry{overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`ChrAccR` is an R package for the analysis of chromatin accessibility data.
It supports popular protocols like the Assay for Transposase-Accessible Chromatin
(ATAC-seq) and Nucleosome Occupancy and Methylome Sequencing (NOMe-seq; beta-stage)
in bulk and single-cell scenarios.

# Installation

To install `ChrAccR` and its dependencies, use the `devtools` installation routine:

```{r, message = FALSE, warning = FALSE, eval = FALSE}
# install devtools if not previously installed
if (!is.element('devtools', installed.packages()[,"Package"])) install.packages('devtools')

# install dependencies
devtools::install_github("demuellae/muLogR")
devtools::install_github("demuellae/muRtools")

# install ChrAccR
devtools::install_github("demuellae/ChrAccR")
```

# Loading the package and example data

Loading `ChrAccR` works just like loading any other R package
```{r, message = FALSE, warning = FALSE}
library(ChrAccR)
```

## Example data

This vignette focuses on the analysis of ATAC-seq data. The `ChrAccRex` data package contains example datasets for `ChrAccR`. If you haven't already installed `ChrAccRex` use
```{r, message = FALSE, warning = FALSE, eval = FALSE}
devtools::install_github("demuellae/ChrAccRex")
```

The example data used in this vignette contains ATAC-seq data for different T cell samples from the immune atlas dataset (https://doi.org/10.1101/409722) and it focuses on only a subset of the human genome (approximately 1%). It can be loaded using:
```{r, message = FALSE, warning = FALSE}
dsa <- ChrAccRex::loadExample("dsAtac_ia_example")
```

# Overview of `ChrAccR` data structures

`ChrAccR` implements data structures for the convenient handling of chromatin accessibility data. Its main class is the `DsAcc` which represents the prototype for more specialized `S4` classes for different types of accessibility protocols. Here, we focus on ATAC-seq data and the corresponding data structure is called `DsATAC`. The example data loaded above is such a `DsATAC` object.

Each `DsATAC` object contains

* A sample annotation table
* Genomic coordinates for one ore more region sets, such as promoters, enhancers, acessibility peaks or genomic tiling windows
* Aggregate counts for each genomic region as quantification of accessibility
* Optionally, the coordinates of sequencing fragments/reads

To get an overview of what information is stored in the example dataset, you can just type the object name:
```{r, message = FALSE, warning = FALSE}
dsa
```

## Accessing information in `DsATAC` datasets

Here are some utility functions that summarize the samples contained in the dataset:
```{r, message = FALSE, warning = FALSE}
# get the sample names
head(getSamples(dsa))
# sample annotation table
str(getSampleAnnot(dsa))
```

To obtain information on the region sets that are contained in the dataset, use:
```{r, message = FALSE, warning = FALSE}
# the names of the different region types
getRegionTypes(dsa)
# number of regions for a particular region type
getNRegions(dsa, "promoters_gc_protein_coding")
# genomic coordinates of a particular region type
getCoord(dsa, "promoters_gc_protein_coding")
```

You can obtain a region-by-sample matrix containing Tn5 insertion counts using the `getCounts` function:
```{r, message = FALSE, warning = FALSE}
cm <- getCounts(dsa, "promoters_gc_protein_coding")
str(cm)
```

If the dataset contains fragment information, you can obtain the coordinates of sequencing fragments for each sample:
```{r, message = FALSE, warning = FALSE}
# number of fragments for the first 10 samples
getFragmentNum(dsa, sampleIds=getSamples(dsa)[1:10])
# start and end coordinates of all fragments for a given sample
getFragmentGr(dsa, "TCD8EM_U_1002")
# all Tn5 insertion sites (i.e. the concatenation of fragment start and end coordinates)
# for a set of samples
getInsertionSites(dsa, getSamples(dsa)[1:3])
```

## Manipulating `DsATAC` datasets

`ChrAccR` provides a number of functions for filtering a dataset and for adding additional data.

## Saving and loading datasets

In many analysis workflow, you want to save an R dataset to disk in order to use it in downstream analysis using custom R scripts. Note that R's workflow of `saveRDS` `readRDS` is  generally not applicable for saving and loading `DsATAC` datasets, because `ChrAccR` optionally uses disk-backed data structures in order to be more memory efficient in the analysis. Instead, please use `ChrAccR`'s functions:
```{r, message = FALSE, warning = FALSE}
dest <- file.path(tempdir(), "myDsAtacDataset")
saveDsAcc(dsa, dest)

dsa_reloaded <- loadDsAcc(dest)
dsa_reloaded
```

# Importing ATAC-seq data
```{r, message = FALSE, warning = FALSE, eval = FALSE}
# download and unzip the dataset
datasetUrl <- "https://s3.amazonaws.com/muellerf/data/ChrAccR/data/tutorial/tcells.zip"
downFn <- "tcells.zip"
download.file(datasetUrl, downFn)
unzip(downFn, exdir=".")
```

```{r, message = FALSE, warning = FALSE, eval = FALSE}
# download and unzip the dataset
sampleAnnotFn <- file.path("tcells", "samples.tsv")
bamDir <- file.path("tcells", "bam")
sampleAnnot <- read.table(sampleAnnotFn, sep="\t", header=TRUE, stringsAsFactors=FALSE)
sampleAnnot[,"bamFilenameFull"] <- file.path(bamDir, sampleAnnot[,"bamFilename"])
```

```{r, message = FALSE, warning = FALSE, eval = FALSE}
dsa <- DsATAC.snakeATAC(sampleAnnot, "bamFilenameFull", "hg38", regionSets=NULL, sampleIdCol="sampleId", diskDump=FALSE, bySample=TRUE)
```

## Importing data from `bam` files

# Analysis reports

## Summary analysis

## Exploratory analysis

## Differential analysis

# Utility functions

## Plot the fragment size distribution
```{r, message = FALSE, warning = FALSE, eval = TRUE}
plotInsertSizeDistribution(dsa, "TCD8EM_U_1002")
```

## TSS enrichment plots
```{r, message = FALSE, warning = FALSE, eval = FALSE}
# prepare a GRanges object of TSS coordinates
tssGr <- muRtools::getAnnotGrl.gencode("gencode.v27")[["gene"]]
tssGr <- tssGr[elementMetadata(tssGr)[,"gene_type"]=="protein_coding"]
tssGr <- promoters(tssGr, upstream=0, downstream=1)
tssGr

# compute TSS enrichment
tsse <- getTssEnrichment(dsa, "TCD8EM_U_1002", tssGr)
# enrichment score: number of insertions at the TSS
# over number of insertion in background regions
tsse$tssEnrichment
# plot
tsse$plot
```

## Transcription factor motif enrichment using `ChromVAR`

```{r, message = FALSE, warning = FALSE, eval = TRUE}
cvRes <- getChromVarDev(dsa, "IA_prog_peaks", motifs="jaspar")
devZ <- deviations(cvRes)
devZ
```

# Session Info

```{r}
Sys.Date()
```

```{r}
sessionInfo()
```

